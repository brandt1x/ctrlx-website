<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Account — Control-X</title>
	<meta name="description" content="Access your Control-X account to manage sign-in, purchases, and secure product downloads in one place." />
	<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="ultimate.css">
	<link rel="icon" type="image/png" href="images/logo.png">
</head>

<body class="success-page">
	<canvas id="site-canvas-bg" class="site-canvas-bg" aria-hidden="true"></canvas>
	<div class="site-vignette" aria-hidden="true"></div>

	<header class="site-header">
		<div class="container header-inner">
			<a href="index.html"><img src="images/logo.png" alt="CTRLX Logo" class="logo-image logo-dark" /></a>
			<a href="index.html"><img src="images/whitelogo.png" alt="CTRLX Logo" class="logo-image logo-light" /></a>
			<div class="header-right">
				<nav class="nav-left">
					<a href="index.html">Home</a>
					<a href="services.html">Services</a>
					<a href="zen-scripts.html">Zen Scripts</a>
				</nav>
				<a href="ultimate.html" class="nav-ultimate nav-center-link">ULTIMATE</a>
				<div class="header-actions">
					<a href="account.html" class="btn account-interface-btn">Account</a>
					<a href="contact.html" class="btn">Contact</a>
					<button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle light mode">
						<span class="theme-toggle-switch">
							<span class="theme-icon theme-icon-dark">☾</span>
							<span class="theme-icon theme-icon-light">☀</span>
						</span>
					</button>
				</div>
			</div>
		</div>
	</header>

	<main class="success-main">
		<div class="success-card ultimate-product ultimate-tilt">
			<div class="ultimate-product-glow"></div>
			<div class="ultimate-product-content">
				<h2 class="success-title">Your Account</h2>
				<p class="success-subtitle">Sign in to unlock instant downloads, license access, and purchase history.</p>

				<div id="account-auth" class="account-auth">
					<form id="auth-form" class="account-auth-form">
						<div class="account-auth-tabs">
							<button type="button" class="account-tab active" data-tab="signin">Sign in</button>
							<button type="button" class="account-tab" data-tab="signup">Sign up</button>
						</div>
						<div id="auth-email" class="account-field">
							<label for="auth-email-input">Email</label>
							<input type="email" id="auth-email-input" required placeholder="you@example.com" autocomplete="email" />
						</div>
						<div id="auth-password" class="account-field">
							<label for="auth-password-input">Password</label>
							<input type="password" id="auth-password-input" required placeholder="••••••••" autocomplete="current-password" />
						</div>
						<div id="auth-error" class="account-error" hidden></div>
						<button type="submit" class="btn" id="auth-submit">Sign in</button>
						<div class="account-divider">or</div>
						<button type="button" class="btn ghost" id="auth-google">Sign in with Google</button>
					</form>
				</div>

				<div id="account-dashboard" class="account-dashboard" hidden>
					<p class="account-welcome">Signed in as <span id="account-email"></span></p>
					<div class="account-dashboard-tabs">
						<button type="button" class="account-tab-btn active" data-dashboard-view="account">Account</button>
						<button type="button" class="account-tab-btn" data-dashboard-view="purchases">View Purchases</button>
					</div>
					<div id="account-overview" class="account-overview">
						<p class="muted">You are securely connected. Use this dashboard to manage access, review purchases, and launch downloads quickly.</p>
						<div class="account-overview-actions">
							<button type="button" class="btn ghost" id="account-signout">Sign out</button>
						</div>
					</div>
					<div id="account-purchases-view" hidden>
						<div id="account-purchases" class="success-downloads"></div>
					</div>
				</div>
				<div class="success-slide-box">
					<p class="success-support-text">Need help fast? <a href="contact.html">Contact support</a> or <a href="https://discord.gg/q9KWFd9xxH" target="_blank" rel="noopener">join our Discord</a> for live updates.</p>
				</div>
			</div>
		</div>
	</main>

	<footer class="site-footer">
		<div class="container">
			<small>© <span id="year"></span> Control-X — All lawful services.</small>
		</div>
	</footer>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="script.js"></script>
	<script src="cinematic.js"></script>
	<script>
		(async function setupAccount() {
			let supabase;
			let oauthRedirectUrl;
			try {
				const cfgRes = await fetch('/api/supabase-config');
				if (!cfgRes.ok) {
					const cfgErr = await cfgRes.json().catch(() => ({}));
					throw new Error(cfgErr.error || ('Failed to load config (' + cfgRes.status + ')'));
				}
				const cfg = await cfgRes.json();
				if (!cfg.url || !cfg.anonKey) throw new Error('Supabase not configured');
				const origin = window.location.origin;
				const isLocalhost = /^https?:\/\/(localhost|127\.0\.0\.1)(:\d+)?$/i.test(origin);
				const baseUrl = cfg.siteUrl || (isLocalhost ? 'https://www.cntrl-x.com' : origin);
				oauthRedirectUrl = baseUrl.replace(/\/$/, '') + '/account.html';
				const lib = window.supabase || window.supabaseJs;
				const createClient = lib?.createClient || lib?.default?.createClient;
				if (!createClient) throw new Error('Supabase script not loaded');
				supabase = createClient(cfg.url, cfg.anonKey);
			} catch (e) {
				const localHint = /^localhost$|^127\.0\.0\.1$/.test(window.location.hostname)
					? ' Run with "vercel dev" and set SUPABASE_URL and SUPABASE_ANON_KEY in .env.local.'
					: ' Set SUPABASE_URL and SUPABASE_ANON_KEY in your Vercel environment variables and redeploy.';
				document.getElementById('auth-error').textContent = (e?.message || 'Supabase not configured.') + localHint;
				document.getElementById('auth-error').hidden = false;
				return;
			}
			const authEl = document.getElementById('account-auth');
			const dashboardEl = document.getElementById('account-dashboard');
			const authForm = document.getElementById('auth-form');
			const authSubmit = document.getElementById('auth-submit');
			const authError = document.getElementById('auth-error');
			const accountEmail = document.getElementById('account-email');
			const purchasesEl = document.getElementById('account-purchases');
			const purchasesView = document.getElementById('account-purchases-view');
			const overviewView = document.getElementById('account-overview');
			const signoutBtn = document.getElementById('account-signout');
			const authPasswordInput = document.getElementById('auth-password-input');
			const authGoogleBtn = document.getElementById('auth-google');
			const tabs = authForm ? authForm.querySelectorAll('.account-tab') : [];
			const dashboardTabs = document.querySelectorAll('.account-tab-btn');
			let mode = 'signin';
			let purchasesLoaded = false;

			function updateAuthMode(newMode) {
				mode = newMode;
				authSubmit.textContent = mode === 'signin' ? 'Sign in' : 'Sign up';
				authPasswordInput.setAttribute('autocomplete', mode === 'signin' ? 'current-password' : 'new-password');
			}

			tabs.forEach(t => {
				t.addEventListener('click', () => {
					tabs.forEach(x => x.classList.remove('active'));
					t.classList.add('active');
					updateAuthMode(t.dataset.tab);
					authError.hidden = true;
				});
			});

			authForm.addEventListener('submit', async (e) => {
				e.preventDefault();
				authError.hidden = true;
				const email = document.getElementById('auth-email-input').value.trim();
				const password = authPasswordInput.value;
				if (!email || !password) return;
				authSubmit.disabled = true;
				try {
					if (mode === 'signin') {
						const { error } = await supabase.auth.signInWithPassword({ email, password });
						if (error) throw error;
						location.reload();
					} else {
						const { data, error } = await supabase.auth.signUp({ email, password });
						if (error) throw error;
						if (data?.user && (!data.user.identities || data.user.identities.length === 0)) {
							authError.textContent = 'Check your email to confirm your account.';
							authError.hidden = false;
						} else {
							location.reload();
						}
					}
				} catch (err) {
					authError.textContent = err.message || 'Something went wrong';
					authError.hidden = false;
				} finally {
					authSubmit.disabled = false;
				}
			});

			authGoogleBtn.addEventListener('click', async () => {
				authError.hidden = true;
				try {
					const { error } = await supabase.auth.signInWithOAuth({
						provider: 'google',
						options: { redirectTo: oauthRedirectUrl }
					});
					if (error) throw error;
				} catch (err) {
					authError.textContent = err.message || 'Google sign-in failed';
					authError.hidden = false;
				}
			});

			signoutBtn.addEventListener('click', async () => {
				await supabase.auth.signOut();
				location.reload();
			});

			function setDashboardView(view) {
				dashboardTabs.forEach((b) => b.classList.toggle('active', b.dataset.dashboardView === view));
				const showPurchases = view === 'purchases';
				purchasesView.hidden = !showPurchases;
				overviewView.hidden = showPurchases;
				if (showPurchases && !purchasesLoaded) {
					loadPurchases();
					purchasesLoaded = true;
				}
			}
			dashboardTabs.forEach((btn) => {
				btn.addEventListener('click', () => setDashboardView(btn.dataset.dashboardView));
			});

			function timeRemaining(expiresAt) {
				const diff = new Date(expiresAt).getTime() - Date.now();
				if (diff <= 0) return null;
				const h = Math.floor(diff / 3600000);
				const m = Math.floor((diff % 3600000) / 60000);
				if (h > 0) return h + 'h ' + m + 'm remaining';
				return m + 'm remaining';
			}

			async function loadPurchases() {
				const { data: { session } } = await supabase.auth.getSession();
				if (!session?.access_token) return;
				const res = await fetch('/api/my-purchases', {
					headers: { 'Authorization': 'Bearer ' + session.access_token } });
				const data = await res.json();
				if (!res.ok) {
					purchasesEl.innerHTML = '<p class="muted">Something went wrong loading your purchases. Please try refreshing the page.</p>';
					return;
				}
				const purchases = data.purchases || [];
				if (purchases.length === 0) {
					purchasesEl.innerHTML = '<p class="muted">You don\'t have any purchases to view yet. Browse our <a href="zen-scripts.html">Zen Scripts</a> or <a href="ultimate.html">Ultimate</a> page and your items will appear here instantly.</p>';
					return;
				}
				const html = purchases.map(p => {
					const expired = p.isExpired;
					const remaining = !expired && p.expiresAt ? timeRemaining(p.expiresAt) : null;
					const links = [];
					function dlBtn(label, type, script) {
						if (expired) {
							return '<span class="btn btn-disabled success-dl-btn-expired">Download expired</span>';
						}
						return '<a href="#" class="btn success-dl-btn" data-session="' + p.session_id + '" data-type="' + type + '"' + (script ? ' data-script="' + script + '"' : '') + '>' + label + '</a>';
					}
					if (p.hasControlX) links.push(dlBtn('Download CONTROL+X Ultimate Script (.gpc)', 'script', 'control-x'));
					if (p.hasVisionX) links.push(dlBtn('Download Vision-X Tempo', 'vision-x', ''));
					if (p.hasAllBundle) links.push(dlBtn('Download All Scripts', 'all-scripts', ''));
					else {
						if (p.has2K) links.push(dlBtn('Download 2K Script (.gpc)', 'script', '2k'));
						if (p.hasCOD) links.push(dlBtn('Download COD Script (.gpc)', 'script', 'cod'));
						if (p.hasApex) links.push(dlBtn('Download Apex Script (.gpc)', 'script', 'apex'));
						if (p.hasArc) links.push(dlBtn('Download ARC Script (.gpc)', 'script', 'arc'));
						if (p.hasFortnite) links.push(dlBtn('Download Fortnite Script (.gpc)', 'script', 'fortnite'));
						if (p.hasSiege) links.push(dlBtn('Download Siege Script (.gpc)', 'script', 'siege'));
						if (p.hasRust) links.push(dlBtn('Download Rust Script (.gpc)', 'script', 'rust'));
					}
					const date = p.created_at ? new Date(p.created_at).toLocaleDateString() : '';
					const statusLabel = expired
						? '<span class="purchase-status purchase-status-expired">Expired</span>'
						: (remaining ? '<span class="purchase-status purchase-status-active">' + remaining + '</span>' : '');
					return '<div class="account-purchase-block' + (expired ? ' purchase-expired' : '') + '"><h4>Purchase ' + date + ' ' + statusLabel + '</h4><div class="success-download-list">' + links.join('') + '</div></div>';
				}).join('');
				purchasesEl.innerHTML = html + '<p class="success-instruction">Load the .gpc file(s) into Zen Studio and flash to your CronusZen.</p>';

				purchasesEl.querySelectorAll('.success-dl-btn').forEach(btn => {
					btn.addEventListener('click', async (e) => {
						e.preventDefault();
						const sessionId = btn.dataset.session;
						const type = btn.dataset.type;
						const script = btn.dataset.script;
						const { data: { session } } = await supabase.auth.getSession();
						if (!session?.access_token) return;
						let url = '/api/download?session_id=' + encodeURIComponent(sessionId) + '&type=';
						if (type === 'vision-x') url += 'vision-x';
						else if (type === 'all-scripts') url += 'all-scripts';
						else url += 'script&script=' + (script || '');
						const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + session.access_token } });
						if (!res.ok) {
							const errData = await res.json().catch(() => ({}));
							alert(errData.error || 'Download failed.');
							return;
						}
						const blob = await res.blob();
						const a = document.createElement('a');
						a.href = URL.createObjectURL(blob);
						a.download = type === 'vision-x' ? 'Vision-X-Tempo.zip' : type === 'all-scripts' ? 'Cntrl-X-All-Scripts.zip' : (script || 'script') + '.gpc';
						a.click();
						URL.revokeObjectURL(a.href);
					});
				});
			}

			supabase.auth.onAuthStateChange((event, session) => {
				if (session) {
					authEl.hidden = true;
					dashboardEl.hidden = false;
					accountEmail.textContent = session.user?.email || '';
					purchasesLoaded = false;
					setDashboardView('account');
				} else {
					authEl.hidden = false;
					dashboardEl.hidden = true;
				}
			});

			async function init() {
				const { data: { session } } = await supabase.auth.getSession();
				const startOnPurchases = location.hash === '#purchases';
				if (session) {
					authEl.hidden = true;
					dashboardEl.hidden = false;
					accountEmail.textContent = session.user?.email || '';
					purchasesLoaded = false;
					setDashboardView(startOnPurchases ? 'purchases' : 'account');
				} else {
					authEl.hidden = false;
					dashboardEl.hidden = true;
				}
			}
			init();
		})();
	</script>
</body>

</html>
